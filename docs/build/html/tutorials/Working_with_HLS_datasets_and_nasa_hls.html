
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Working with HLS datasets: cloud cover, GeoTIFFs, and the QA band &#8212; nasa_hls 0.0.3 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Changelog" href="../changelog_link.html" />
    <link rel="prev" title="Query and download HLS datasets with nasa_hls" href="Query_and_download_hls_datasets_with_nasa_hls.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container,
div.nbinput.container div.prompt,
div.nbinput.container div.input_area,
div.nbinput.container div[class*=highlight],
div.nbinput.container div[class*=highlight] pre,
div.nboutput.container,
div.nboutput.container div.prompt,
div.nboutput.container div.output_area,
div.nboutput.container div[class*=highlight],
div.nboutput.container div[class*=highlight] pre {
    background: none;
    border: none;
    padding: 0 0;
    margin: 0;
    box-shadow: none;
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    min-width: 5.5ex;
    padding-top: 0.3rem;
    padding-right: 0.3rem;
    text-align: right;
    flex: 0;
}
@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    background: #f5f5f5;
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 0.3rem;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}
</style>
<div class="section" id="Working-with-HLS-datasets:-cloud-cover,-GeoTIFFs,-and-the-QA-band">
<h1>Working with HLS datasets: cloud cover, GeoTIFFs, and the QA band<a class="headerlink" href="#Working-with-HLS-datasets:-cloud-cover,-GeoTIFFs,-and-the-QA-band" title="Permalink to this headline">¶</a></h1>
<p>This guide shows how to use some of the utilities implemented in <em>nasa_hls</em> for working with NASA’s Harmonized Landsat and Sentinel-2 Project (<a class="reference external" href="https://hls.gsfc.nasa.gov/">https://hls.gsfc.nasa.gov/</a>) data. It covers the follwoing topics:</p>
<ul class="simple">
<li><p>Derive the cloud cover percentage from the metadata of a HDF file.</p></li>
<li><p>Convert HDF datasets to single layer GeoTIFFs.</p></li>
<li><p>Convert the binary QA layer in a clear-sky mask.</p></li>
</ul>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2
<span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">rasterio</span>

<span class="kn">import</span> <span class="nn">nasa_hls</span>
</pre></div>
</div>
</div>
<div class="section" id="The-sample-data">
<h2>The sample data<a class="headerlink" href="#The-sample-data" title="Permalink to this headline">¶</a></h2>
<p>We assume the data that has been created wiht the ‘Query and download HLS datasets with <em>nasa_hls</em>’ guide.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">hdf_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./xxx_uncontrolled_hls/downloads&quot;</span><span class="p">)</span>
<span class="n">geotiff_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./xxx_uncontrolled_hls/geotiffs&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="n">df_downloaded</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;./xxx_uncontrolled_hls/downloads/df_downloads.csv&quot;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="s2">&quot;id&quot;</span><span class="p">)</span>
<span class="n">display</span><span class="p">(</span><span class="n">df_downloaded</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>product</th>
      <th>tile</th>
      <th>date</th>
      <th>url</th>
      <th>year</th>
      <th>month</th>
      <th>day</th>
      <th>path</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>HLS.L30.T32UNU.2018092.v1.4</th>
      <td>L30</td>
      <td>32UNU</td>
      <td>2018-04-02</td>
      <td>https://hls.gsfc.nasa.gov/data/v1.4/L30/2018/3...</td>
      <td>2018</td>
      <td>4</td>
      <td>2</td>
      <td>./xxx_uncontrolled_hls/downloads/HLS.L30.T32UN...</td>
    </tr>
    <tr>
      <th>HLS.S30.T32UNU.2018092.v1.4</th>
      <td>S30</td>
      <td>32UNU</td>
      <td>2018-04-02</td>
      <td>https://hls.gsfc.nasa.gov/data/v1.4/S30/2018/3...</td>
      <td>2018</td>
      <td>4</td>
      <td>2</td>
      <td>./xxx_uncontrolled_hls/downloads/HLS.S30.T32UN...</td>
    </tr>
    <tr>
      <th>HLS.L30.T32UPU.2018092.v1.4</th>
      <td>L30</td>
      <td>32UPU</td>
      <td>2018-04-02</td>
      <td>https://hls.gsfc.nasa.gov/data/v1.4/L30/2018/3...</td>
      <td>2018</td>
      <td>4</td>
      <td>2</td>
      <td>./xxx_uncontrolled_hls/downloads/HLS.L30.T32UP...</td>
    </tr>
    <tr>
      <th>HLS.S30.T32UPU.2018092.v1.4</th>
      <td>S30</td>
      <td>32UPU</td>
      <td>2018-04-02</td>
      <td>https://hls.gsfc.nasa.gov/data/v1.4/S30/2018/3...</td>
      <td>2018</td>
      <td>4</td>
      <td>2</td>
      <td>./xxx_uncontrolled_hls/downloads/HLS.S30.T32UP...</td>
    </tr>
    <tr>
      <th>HLS.L30.T32UPU.2018099.v1.4</th>
      <td>L30</td>
      <td>32UPU</td>
      <td>2018-04-09</td>
      <td>https://hls.gsfc.nasa.gov/data/v1.4/L30/2018/3...</td>
      <td>2018</td>
      <td>4</td>
      <td>9</td>
      <td>./xxx_uncontrolled_hls/downloads/HLS.L30.T32UP...</td>
    </tr>
    <tr>
      <th>HLS.S30.T32UPU.2018099.v1.4</th>
      <td>S30</td>
      <td>32UPU</td>
      <td>2018-04-09</td>
      <td>https://hls.gsfc.nasa.gov/data/v1.4/S30/2018/3...</td>
      <td>2018</td>
      <td>4</td>
      <td>9</td>
      <td>./xxx_uncontrolled_hls/downloads/HLS.S30.T32UP...</td>
    </tr>
    <tr>
      <th>HLS.L30.T32UNU.2018115.v1.4</th>
      <td>L30</td>
      <td>32UNU</td>
      <td>2018-04-25</td>
      <td>https://hls.gsfc.nasa.gov/data/v1.4/L30/2018/3...</td>
      <td>2018</td>
      <td>4</td>
      <td>25</td>
      <td>./xxx_uncontrolled_hls/downloads/HLS.L30.T32UN...</td>
    </tr>
    <tr>
      <th>HLS.S30.T32UNU.2018115.v1.4</th>
      <td>S30</td>
      <td>32UNU</td>
      <td>2018-04-25</td>
      <td>https://hls.gsfc.nasa.gov/data/v1.4/S30/2018/3...</td>
      <td>2018</td>
      <td>4</td>
      <td>25</td>
      <td>./xxx_uncontrolled_hls/downloads/HLS.S30.T32UN...</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
</div>
<div class="section" id="Derive-metadata-from-HDF-file">
<h2>Derive metadata from HDF file<a class="headerlink" href="#Derive-metadata-from-HDF-file" title="Permalink to this headline">¶</a></h2>
<p>The HDF files come with rich metadata that can be read from the files with <code class="docutils literal notranslate"><span class="pre">gdalinfo</span></code>. The <a class="reference external" href="https://hls.gsfc.nasa.gov/wp-content/uploads/2019/01/HLS.v1.4.UserGuide_draft_ver3.1.pdf">HLS v1.4 UserGuide</a> lists the metadata fields with a short description in Section 6.6.</p>
<p>The full outcome of <code class="docutils literal notranslate"><span class="pre">gdalinfo</span></code> for the sample scene looks as follows:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre>
<span></span>%%bash
gdalinfo ./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Driver: HDF4/Hierarchical Data Format Release 4
Files: ./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf
Size is 512, 512
Metadata:
  ACCODE=LaSRCL8V3.5.5; LaSRCL8V3.5.5
  arop_ave_xshift(meters)=-10.5, -17.0999999999767
  arop_ave_yshift(meters)=-10.5, -10.5
  arop_ncp=156, 364
  arop_rmse(meters)=4.32, 3.91
  arop_s2_refimg=/nobackupp6/jju/S2REFIMG/32UNU_2016273A.S2A_OPER_MSI_L1C_TL_SGS__20160929T154211_A006640_T32UNU_B08.jp2
  cloud_coverage=24
  DATA_TYPE=L1TP; L1TP
  HLS_PROCESSING_TIME=2018-05-22T01:14:35Z
  HORIZONTAL_CS_NAME=UTM, WGS84, UTM ZONE 32; UTM, WGS84, UTM ZONE 32
  L1_PROCESSING_TIME=2018-04-16T22:40:45Z; 2018-04-16T22:42:02Z
  LANDSAT_PRODUCT_ID=LC08_L1TP_193026_20180402_20180416_01_T1; LC08_L1TP_193027_20180402_20180416_01_T1
  LANDSAT_SCENE_ID=LC81930262018092LGN00; LC81930272018092LGN00
  MEAN_SUN_AZIMUTH_ANGLE=154.21429006, 152.99684032
  MEAN_SUN_ZENITH_ANGLE=46.61961515, 45.48706472
  NBAR_Solar_Zenith=50.3345670872353
  NCOLS=3660
  NROWS=3660
  SENSING_TIME=2018-04-02T10:03:11.3268150Z; 2018-04-02T10:03:35.2051460Z
  SENSOR=OLI_TIRS; OLI_TIRS
  SENTINEL2_TILEID=32UNU
  spatial_coverage=29
  SPATIAL_RESOLUTION=30
  TIRS_SSM_MODEL=FINAL; FINAL
  TIRS_SSM_POSITION_STATUS=ESTIMATED; ESTIMATED
  ULX=499980
  ULY=5400000
  USGS_SOFTWARE=LPGS_13.0.0
Subdatasets:
  SUBDATASET_1_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band01
  SUBDATASET_1_DESC=[3660x3660] band01 Grid (16-bit integer)
  SUBDATASET_2_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band02
  SUBDATASET_2_DESC=[3660x3660] band02 Grid (16-bit integer)
  SUBDATASET_3_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band03
  SUBDATASET_3_DESC=[3660x3660] band03 Grid (16-bit integer)
  SUBDATASET_4_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band04
  SUBDATASET_4_DESC=[3660x3660] band04 Grid (16-bit integer)
  SUBDATASET_5_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band05
  SUBDATASET_5_DESC=[3660x3660] band05 Grid (16-bit integer)
  SUBDATASET_6_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band06
  SUBDATASET_6_DESC=[3660x3660] band06 Grid (16-bit integer)
  SUBDATASET_7_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band07
  SUBDATASET_7_DESC=[3660x3660] band07 Grid (16-bit integer)
  SUBDATASET_8_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band09
  SUBDATASET_8_DESC=[3660x3660] band09 Grid (16-bit integer)
  SUBDATASET_9_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band10
  SUBDATASET_9_DESC=[3660x3660] band10 Grid (16-bit integer)
  SUBDATASET_10_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:band11
  SUBDATASET_10_DESC=[3660x3660] band11 Grid (16-bit integer)
  SUBDATASET_11_NAME=HDF4_EOS:EOS_GRID:&#34;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&#34;:Grid:QA
  SUBDATASET_11_DESC=[3660x3660] QA Grid (8-bit unsigned integer)
Corner Coordinates:
Upper Left  (    0.0,    0.0)
Lower Left  (    0.0,  512.0)
Upper Right (  512.0,    0.0)
Lower Right (  512.0,  512.0)
Center      (  256.0,  256.0)
</pre></div></div>
</div>
<p>The values for the fields separated from its values with a ‘=’ derived given a HDF file.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">nasa_hls</span><span class="o">.</span><span class="n">get_metadata_from_hdf</span><span class="p">(</span><span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial_coverage&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;cloud_cover&#39;: 24.0, &#39;spatial_coverage&#39;: 29.0}
</pre></div></div>
</div>
<p>Note that you will still get a dictionary back even if a specified field cannot be found. However you should get a warning for each field that could not be found.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nasa_hls</span><span class="o">.</span><span class="n">get_metadata_from_hdf</span><span class="p">(</span><span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">,</span> <span class="s2">&quot;ZZZZZ&quot;</span><span class="p">,</span> <span class="s2">&quot;DUBIDUBIDUUU&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
/home/ben/Devel/Repos_Py/nasa_hls/nasa_hls/utils.py:210: UserWarning: Could not find metadata for field &#39;ZZZZZ&#39;.
  warnings.warn(f&#34;Could not find metadata for field &#39;{field}&#39;.&#34;)
/home/ben/Devel/Repos_Py/nasa_hls/nasa_hls/utils.py:210: UserWarning: Could not find metadata for field &#39;DUBIDUBIDUUU&#39;.
  warnings.warn(f&#34;Could not find metadata for field &#39;{field}&#39;.&#34;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
{&#39;cloud_cover&#39;: 24.0}
</pre></div></div>
</div>
<p>Here we derive the cloud cover and spatial coverage for all the downloaded scenes.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
<span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;spatial_coverage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">df_downloaded</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
    <span class="n">_</span> <span class="o">=</span> <span class="n">nasa_hls</span><span class="o">.</span><span class="n">get_metadata_from_hdf</span><span class="p">(</span><span class="n">df_downloaded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;path&quot;</span><span class="p">],</span>
                                       <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">,</span>
                                               <span class="s2">&quot;spatial_coverage&quot;</span><span class="p">])</span>
    <span class="n">df_downloaded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;cloud_cover&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">]</span>
    <span class="n">df_downloaded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;spatial_coverage&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_</span><span class="p">[</span><span class="s2">&quot;spatial_coverage&quot;</span><span class="p">]</span>
<span class="n">df_downloaded</span><span class="p">[[</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial_coverage&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>cloud_cover</th>
      <th>spatial_coverage</th>
    </tr>
    <tr>
      <th>id</th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>HLS.L30.T32UNU.2018092.v1.4</th>
      <td>24.0</td>
      <td>29.0</td>
    </tr>
    <tr>
      <th>HLS.S30.T32UNU.2018092.v1.4</th>
      <td>85.0</td>
      <td>100.0</td>
    </tr>
    <tr>
      <th>HLS.L30.T32UPU.2018092.v1.4</th>
      <td>11.0</td>
      <td>100.0</td>
    </tr>
    <tr>
      <th>HLS.S30.T32UPU.2018092.v1.4</th>
      <td>66.0</td>
      <td>100.0</td>
    </tr>
    <tr>
      <th>HLS.L30.T32UPU.2018099.v1.4</th>
      <td>100.0</td>
      <td>50.0</td>
    </tr>
    <tr>
      <th>HLS.S30.T32UPU.2018099.v1.4</th>
      <td>100.0</td>
      <td>72.0</td>
    </tr>
    <tr>
      <th>HLS.L30.T32UNU.2018115.v1.4</th>
      <td>28.0</td>
      <td>100.0</td>
    </tr>
    <tr>
      <th>HLS.S30.T32UNU.2018115.v1.4</th>
      <td>47.0</td>
      <td>58.0</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Or as a plot:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;product_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;product&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span>
<span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;date_tile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;-&quot;</span> <span class="o">+</span> <span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;tile&quot;</span><span class="p">]</span>
<span class="c1">#df_downloaded.pivot(index=&quot;product_date&quot;, columns=&quot;tile&quot;, values=&quot;cloud_cover&quot;).plot.bar(figsize=(16, 6))</span>
<span class="n">df_downloaded</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="s2">&quot;date_tile&quot;</span><span class="p">,</span>
                    <span class="n">columns</span><span class="o">=</span><span class="s2">&quot;product&quot;</span><span class="p">,</span>
                    <span class="n">values</span><span class="o">=</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5f705a8b80&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Working_with_HLS_datasets_and_nasa_hls_13_1.png" src="../_images/tutorials_Working_with_HLS_datasets_and_nasa_hls_13_1.png" />
</div>
</div>
</div>
<div class="section" id="Convert-HDF-to-single-layer-GeoTIFFs">
<h2>Convert HDF to single-layer GeoTIFFs<a class="headerlink" href="#Convert-HDF-to-single-layer-GeoTIFFs" title="Permalink to this headline">¶</a></h2>
<p><strong>Note</strong>: Starting from <strong>nasa_hls</strong> version 0.1.1 you can also convert the data to Cloud Optimized GeoTIFFs (COG). This also requires GDAL &gt;= 3.1.</p>
<p>To create COGs use teh option <code class="docutils literal notranslate"><span class="pre">gdal_translate_options=&quot;-of</span> <span class="pre">COG&quot;</span></code> in <code class="docutils literal notranslate"><span class="pre">convert_hdf2tiffs</span></code>.</p>
<div class="section" id="Single-scene">
<h3>Single scene<a class="headerlink" href="#Single-scene" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># L30</span>
<span class="n">nasa_hls</span><span class="o">.</span><span class="n">convert_hdf2tiffs</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./xxx_uncontrolled_hls/downloads/HLS.L30.T32UNU.2018092.v1.4.hdf&quot;</span><span class="p">),</span>
                           <span class="n">geotiff_dir</span><span class="p">,</span>
                           <span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># use this to convert only a subset of the bands</span>
                           <span class="n">max_cloud_coverage</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>  <span class="c1"># use this to only convert scenes that have lower than specified cloud cover</span>
                          <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PosixPath(&#39;xxx_uncontrolled_hls/geotiffs/HLS.L30.T32UNU.2018092.v1.4&#39;)
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># S30</span>
<span class="n">nasa_hls</span><span class="o">.</span><span class="n">convert_hdf2tiffs</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="s2">&quot;./xxx_uncontrolled_hls/downloads/HLS.S30.T32UNU.2018092.v1.4.hdf&quot;</span><span class="p">),</span>
                           <span class="n">geotiff_dir</span><span class="p">,</span>
                           <span class="n">bands</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                           <span class="n">max_cloud_coverage</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                          <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
PosixPath(&#39;xxx_uncontrolled_hls/geotiffs/HLS.S30.T32UNU.2018092.v1.4&#39;)
</pre></div></div>
</div>
<p>As a result you get all the (desired) bands in a subfolder of the destination directory. Note the differences between the L30 and S30 files.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-bash notranslate"><div class="highlight"><pre>
<span></span>%%bash
tree xxx_uncontrolled_hls/geotiffs/HLS.L30.T32UNU.2018092.v1.4
tree xxx_uncontrolled_hls/geotiffs/HLS.S30.T32UNU.2018092.v1.4
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
xxx_uncontrolled_hls/geotiffs/HLS.L30.T32UNU.2018092.v1.4
├── HLS.L30.T32UNU.2018092.v1.4__Blue.tif
├── HLS.L30.T32UNU.2018092.v1.4__Cirrus.tif
├── HLS.L30.T32UNU.2018092.v1.4__Coastal_Aerosol.tif
├── HLS.L30.T32UNU.2018092.v1.4__Green.tif
├── HLS.L30.T32UNU.2018092.v1.4__NIR.tif
├── HLS.L30.T32UNU.2018092.v1.4__QA.tif
├── HLS.L30.T32UNU.2018092.v1.4__Red.tif
├── HLS.L30.T32UNU.2018092.v1.4__SWIR1.tif
├── HLS.L30.T32UNU.2018092.v1.4__SWIR2.tif
├── HLS.L30.T32UNU.2018092.v1.4__TIRS1.tif
└── HLS.L30.T32UNU.2018092.v1.4__TIRS2.tif

0 directories, 11 files
xxx_uncontrolled_hls/geotiffs/HLS.S30.T32UNU.2018092.v1.4
├── HLS.S30.T32UNU.2018092.v1.4__Blue.tif
├── HLS.S30.T32UNU.2018092.v1.4__Cirrus.tif
├── HLS.S30.T32UNU.2018092.v1.4__Coastal_Aerosol.tif
├── HLS.S30.T32UNU.2018092.v1.4__Green.tif
├── HLS.S30.T32UNU.2018092.v1.4__NIR_Broad.tif
├── HLS.S30.T32UNU.2018092.v1.4__NIR_Narrow.tif
├── HLS.S30.T32UNU.2018092.v1.4__QA.tif
├── HLS.S30.T32UNU.2018092.v1.4__Red_Edge1.tif
├── HLS.S30.T32UNU.2018092.v1.4__Red_Edge2.tif
├── HLS.S30.T32UNU.2018092.v1.4__Red_Edge3.tif
├── HLS.S30.T32UNU.2018092.v1.4__Red.tif
├── HLS.S30.T32UNU.2018092.v1.4__SWIR1.tif
├── HLS.S30.T32UNU.2018092.v1.4__SWIR2.tif
└── HLS.S30.T32UNU.2018092.v1.4__Water_Vapor.tif

0 directories, 14 files
</pre></div></div>
</div>
</div>
<div class="section" id="Batch-of-scene">
<h3>Batch of scene<a class="headerlink" href="#Batch-of-scene" title="Permalink to this headline">¶</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">nasa_hls</span><span class="o">.</span><span class="n">convert_hdf2tiffs_batch</span><span class="p">(</span><span class="n">df_downloaded</span><span class="p">[</span><span class="n">df_downloaded</span><span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;2018-04-02&quot;</span><span class="p">][</span><span class="s2">&quot;path&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                                 <span class="n">geotiff_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area stderr docutils container">
<div class="highlight"><pre>
100%|██████████| 4/4 [00:29&lt;00:00,  7.28s/it]
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
[PosixPath(&#39;xxx_uncontrolled_hls/geotiffs/HLS.L30.T32UNU.2018092.v1.4&#39;),
 PosixPath(&#39;xxx_uncontrolled_hls/geotiffs/HLS.S30.T32UNU.2018092.v1.4&#39;),
 PosixPath(&#39;xxx_uncontrolled_hls/geotiffs/HLS.L30.T32UPU.2018092.v1.4&#39;),
 PosixPath(&#39;xxx_uncontrolled_hls/geotiffs/HLS.S30.T32UPU.2018092.v1.4&#39;)]
</pre></div></div>
</div>
</div>
</div>
<div class="section" id="Create-a-clear-sky-mask-from-the-QA-layer">
<h2>Create a clear-sky mask from the QA layer<a class="headerlink" href="#Create-a-clear-sky-mask-from-the-QA-layer" title="Permalink to this headline">¶</a></h2>
<p>The <a class="reference external" href="https://hls.gsfc.nasa.gov/wp-content/uploads/2019/01/HLS.v1.4.UserGuide_draft_ver3.1.pdf">HLS v1.4 UserGuide</a> helps to understanding and use the QA layer.</p>
<p>We can read in <em>Appendix A. How to decode the bit-packed QA</em>:</p>
<p><em>Quality Assessment (QA) encoded at the bit level provides concise presentation but is less convenient for users new to this format.</em></p>
<p>This is really true especially if compare the difficulty in handling the QA layer to handling the fmask or sen2cor SCL layer layer. Because of that and since the masking of invalid pixels / selection of clear sky pixels is so important we will go in a bit more detail here.</p>
<p>The rest of this section shows how to create the default mask and custom masks from the bit encoded AQ layer.</p>
<div class="section" id="Sample-QA-layer">
<h3>Sample QA layer<a class="headerlink" href="#Sample-QA-layer" title="Permalink to this headline">¶</a></h3>
<p>For illustration purposes we use the QA layer of the <em>HLS.L30.T32UNU.2018092.v1.4</em> scene.</p>
<p>From the metadata we got the following information about the HDF file:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_downloaded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;HLS.L30.T32UNU.2018092.v1.4&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial_coverage&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
cloud_cover         24
spatial_coverage    29
Name: HLS.L30.T32UNU.2018092.v1.4, dtype: object
</pre></div></div>
</div>
</div>
<div class="section" id="Understand-the-QA-layer">
<h3>Understand the QA layer<a class="headerlink" href="#Understand-the-QA-layer" title="Permalink to this headline">¶</a></h3>
<p>The metadata also gives us a <em>QA description</em>. We also find that information in the <a class="reference external" href="https://hls.gsfc.nasa.gov/wp-content/uploads/2019/01/HLS.v1.4.UserGuide_draft_ver3.1.pdf">HLS v1.4 UserGuide</a>:</p>
<p><img alt="title" src="../_images/qa_table.png" /></p>
<p><em>Appendix A</em> of the <a class="reference external" href="https://hls.gsfc.nasa.gov/wp-content/uploads/2019/01/HLS.v1.4.UserGuide_draft_ver3.1.pdf">HLS v1.4 UserGuide</a> <em>shows how to decode the QA bits with simple integer arithmetic</em>. Here we show a way how to do this in Python.</p>
<p>Lets start with the example from the <em>Appendix A</em>:</p>
<p><em>Suppose we get a decimal QA value 100, which translates into binary 01100100, indicating that the aerosol level is low (bits 6-7), it is water (bit 5), and adjacent to cloud (bit 2).</em></p>
</div>
<div class="section" id="Derive-clear-sky-mask-from-the-QA-layer">
<h3>Derive clear-sky mask from the QA layer<a class="headerlink" href="#Derive-clear-sky-mask-from-the-QA-layer" title="Permalink to this headline">¶</a></h3>
<p>The guide gives some advice on how to use the QA layer:</p>
<p><em>Users are advised to mask out Cirrus, Cloud and Adjacent cloud pixels.</em></p>
<p>We want to find out here, which rules have been used to calculate the cloud cover we find in in the metadata. There is no explicit information about the used rules.</p>
<p>Therefore we first create a dataframe where the information of the table above is expanded for easier accessability. The dataframe can be created with <code class="docutils literal notranslate"><span class="pre">get_qa_look_up_table</span></code>.</p>
<p>It contains the QA value (i.e. the integer in the raster), the binary string and a boolean column which indicates if for a given QA value a given QA case (i.e. a row in the table above) is met.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">lut_qa</span> <span class="o">=</span> <span class="n">nasa_hls</span><span class="o">.</span><span class="n">get_qa_look_up_table</span><span class="p">()</span>
<span class="n">display</span><span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">head</span><span class="p">())</span>
<span class="n">display</span><span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">tail</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>qa_value</th>
      <th>binary_string</th>
      <th>a_clima</th>
      <th>a_low</th>
      <th>a_avg</th>
      <th>a_high</th>
      <th>water</th>
      <th>snow</th>
      <th>cloud_shadow</th>
      <th>adj_cloud</th>
      <th>cloud</th>
      <th>cirrus</th>
      <th>no_water</th>
      <th>no_snow</th>
      <th>no_cloud_shadow</th>
      <th>no_adj_cloud</th>
      <th>no_cloud</th>
      <th>no_cirrus</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>00000000</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>00000001</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2</td>
      <td>00000010</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>00000011</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>00000100</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>qa_value</th>
      <th>binary_string</th>
      <th>a_clima</th>
      <th>a_low</th>
      <th>a_avg</th>
      <th>a_high</th>
      <th>water</th>
      <th>snow</th>
      <th>cloud_shadow</th>
      <th>adj_cloud</th>
      <th>cloud</th>
      <th>cirrus</th>
      <th>no_water</th>
      <th>no_snow</th>
      <th>no_cloud_shadow</th>
      <th>no_adj_cloud</th>
      <th>no_cloud</th>
      <th>no_cirrus</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>251</th>
      <td>251</td>
      <td>11111011</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>252</th>
      <td>252</td>
      <td>11111100</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>253</th>
      <td>253</td>
      <td>11111101</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>254</th>
      <td>254</td>
      <td>11111110</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
    </tr>
    <tr>
      <th>255</th>
      <td>255</td>
      <td>11111111</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<p>Based on that dataframe it is easy to get the QA integer values for creating a specific mask from it.</p>
<div class="section" id="Find-masking-rules-resulting-in-metadata-cloud-cover">
<h4>Find masking rules resulting in metadata cloud cover<a class="headerlink" href="#Find-masking-rules-resulting-in-metadata-cloud-cover" title="Permalink to this headline">¶</a></h4>
<p>As an example let us see if we can calculate the cloud cover from the QA layer by finding the right QA attributes to be masked.</p>
<p>Let’s get the QA values of the sample scene.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">qa_path</span> <span class="o">=</span> <span class="s1">&#39;./xxx_uncontrolled_hls/geotiffs/HLS.L30.T32UNU.2018092.v1.4/HLS.L30.T32UNU.2018092.v1.4__QA.tif&#39;</span>
<span class="k">with</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">qa_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">qa</span><span class="p">:</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">meta</span>
    <span class="n">qa_array</span> <span class="o">=</span> <span class="n">qa</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Let’s first visualize the distribution of the values:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">qa_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">qa_array</span><span class="p">),</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">])</span>
<span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;binary&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="o">.</span><span class="n">integer</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="s2">&quot;</span><span class="si">{0:08b}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
<span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="o">.</span><span class="n">integer</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">i</span><span class="p">:</span> <span class="p">(</span><span class="n">qa_array</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>

<span class="n">n_pix</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">n_obs</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="p">[</span><span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">]</span><span class="o">.</span><span class="n">counts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;number of observations (not 255) :&quot;</span><span class="p">,</span> <span class="n">n_obs</span><span class="p">)</span>
<span class="n">qa_counts</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;binary&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;counts&quot;</span><span class="p">,</span> <span class="n">logy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
number of observations (not 255) : 3930335
</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.axes._subplots.AxesSubplot at 0x7f5f7029ee50&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Working_with_HLS_datasets_and_nasa_hls_30_2.png" src="../_images/tutorials_Working_with_HLS_datasets_and_nasa_hls_30_2.png" />
</div>
</div>
<p>Let’s also calculate the percentage of pixels with respect to all pixels and with respect to the observed pixels (i.e. not 255):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;percent&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_pix</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;percent_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;counts&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">n_obs</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">qa_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">,</span> <span class="s2">&quot;percent_obs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.01</span>
<span class="n">qa_counts</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>

<span class="n">qa_counts_top_22</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s2">&quot;percent_obs&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">22</span><span class="p">)</span>
<span class="n">qa_counts_top_22</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area rendered_html docutils container">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>integer</th>
      <th>binary</th>
      <th>counts</th>
      <th>percent</th>
      <th>percent_obs</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19</th>
      <td>128</td>
      <td>10000000</td>
      <td>1389745</td>
      <td>10.37</td>
      <td>35.36</td>
    </tr>
    <tr>
      <th>42</th>
      <td>192</td>
      <td>11000000</td>
      <td>991982</td>
      <td>7.41</td>
      <td>25.24</td>
    </tr>
    <tr>
      <th>0</th>
      <td>64</td>
      <td>01000000</td>
      <td>535713</td>
      <td>4.00</td>
      <td>13.63</td>
    </tr>
    <tr>
      <th>43</th>
      <td>193</td>
      <td>11000001</td>
      <td>228818</td>
      <td>1.71</td>
      <td>5.82</td>
    </tr>
    <tr>
      <th>45</th>
      <td>195</td>
      <td>11000011</td>
      <td>185779</td>
      <td>1.39</td>
      <td>4.73</td>
    </tr>
    <tr>
      <th>44</th>
      <td>194</td>
      <td>11000010</td>
      <td>170090</td>
      <td>1.27</td>
      <td>4.33</td>
    </tr>
    <tr>
      <th>27</th>
      <td>136</td>
      <td>10001000</td>
      <td>79370</td>
      <td>0.59</td>
      <td>2.02</td>
    </tr>
    <tr>
      <th>50</th>
      <td>200</td>
      <td>11001000</td>
      <td>57441</td>
      <td>0.43</td>
      <td>1.46</td>
    </tr>
    <tr>
      <th>51</th>
      <td>201</td>
      <td>11001001</td>
      <td>53104</td>
      <td>0.40</td>
      <td>1.35</td>
    </tr>
    <tr>
      <th>23</th>
      <td>132</td>
      <td>10000100</td>
      <td>44661</td>
      <td>0.33</td>
      <td>1.14</td>
    </tr>
    <tr>
      <th>53</th>
      <td>203</td>
      <td>11001011</td>
      <td>38433</td>
      <td>0.29</td>
      <td>0.98</td>
    </tr>
    <tr>
      <th>49</th>
      <td>199</td>
      <td>11000111</td>
      <td>28472</td>
      <td>0.21</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th>52</th>
      <td>202</td>
      <td>11001010</td>
      <td>28155</td>
      <td>0.21</td>
      <td>0.72</td>
    </tr>
    <tr>
      <th>46</th>
      <td>196</td>
      <td>11000100</td>
      <td>26763</td>
      <td>0.20</td>
      <td>0.68</td>
    </tr>
    <tr>
      <th>8</th>
      <td>72</td>
      <td>01001000</td>
      <td>18869</td>
      <td>0.14</td>
      <td>0.48</td>
    </tr>
    <tr>
      <th>4</th>
      <td>68</td>
      <td>01000100</td>
      <td>10947</td>
      <td>0.08</td>
      <td>0.28</td>
    </tr>
    <tr>
      <th>28</th>
      <td>137</td>
      <td>10001001</td>
      <td>7772</td>
      <td>0.06</td>
      <td>0.20</td>
    </tr>
    <tr>
      <th>20</th>
      <td>129</td>
      <td>10000001</td>
      <td>7303</td>
      <td>0.05</td>
      <td>0.19</td>
    </tr>
    <tr>
      <th>47</th>
      <td>197</td>
      <td>11000101</td>
      <td>5277</td>
      <td>0.04</td>
      <td>0.13</td>
    </tr>
    <tr>
      <th>48</th>
      <td>198</td>
      <td>11000110</td>
      <td>5087</td>
      <td>0.04</td>
      <td>0.13</td>
    </tr>
    <tr>
      <th>25</th>
      <td>134</td>
      <td>10000110</td>
      <td>4114</td>
      <td>0.03</td>
      <td>0.10</td>
    </tr>
    <tr>
      <th>57</th>
      <td>207</td>
      <td>11001111</td>
      <td>1991</td>
      <td>0.01</td>
      <td>0.05</td>
    </tr>
  </tbody>
</table>
</div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">df_downloaded</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s2">&quot;HLS.L30.T32UNU.2018092.v1.4&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;cloud_cover&quot;</span><span class="p">,</span> <span class="s2">&quot;spatial_coverage&quot;</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
cloud_cover         24
spatial_coverage    29
Name: HLS.L30.T32UNU.2018092.v1.4, dtype: object
</pre></div></div>
</div>
<p><strong>Spatial coverage</strong></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;spatial coverage from QA: &quot;</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">qa_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">qa_counts</span><span class="p">[</span><span class="s2">&quot;integer&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
spatial coverage from QA:  29.340000000000003
</pre></div></div>
</div>
<p><strong>Cloud cover</strong></p>
<p>I could not find in the docs how the AQ layer was used to calculate the cloud cover.</p>
<p>With the percentages in <code class="docutils literal notranslate"><span class="pre">qa_counts</span></code> and the <code class="docutils literal notranslate"><span class="pre">lut_qa</span></code> dataframe it is now easy to see how different masking decisions influence the percentage of masked pixels for a given QA layer.</p>
<p>The following shows my guesses to find a match for a cloud cover of 24 %.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">valid</span> <span class="o">=</span> <span class="n">lut_qa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="o">~</span><span class="p">((</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cirrus</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">adj_cloud</span><span class="p">)),</span> <span class="s2">&quot;qa_value&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">percent_valid</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">qa_counts</span><span class="o">.</span><span class="n">integer</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span> <span class="s2">&quot;percent_obs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="mi">100</span> <span class="o">-</span> <span class="n">percent_valid</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
21.810000000000002
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">valid</span> <span class="o">=</span> <span class="n">lut_qa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="o">~</span><span class="p">((</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">adj_cloud</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cloud_shadow</span><span class="p">)),</span> <span class="s2">&quot;qa_value&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># =&gt; 19.8</span>
<span class="n">percent_valid</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">qa_counts</span><span class="o">.</span><span class="n">integer</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span> <span class="s2">&quot;percent_obs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="mi">100</span> <span class="o">-</span> <span class="n">percent_valid</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
19.75999999999999
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">valid</span> <span class="o">=</span> <span class="n">lut_qa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="o">~</span><span class="p">((</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cirrus</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">adj_cloud</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cloud_shadow</span><span class="p">)),</span> <span class="s2">&quot;qa_value&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># =&gt; 25.8</span>
<span class="n">percent_valid</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">qa_counts</span><span class="o">.</span><span class="n">integer</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span> <span class="s2">&quot;percent_obs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="mi">100</span> <span class="o">-</span> <span class="n">percent_valid</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
25.769999999999996
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">valid</span> <span class="o">=</span> <span class="n">lut_qa</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
        <span class="o">~</span><span class="p">((</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cirrus</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cloud</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lut_qa</span><span class="o">.</span><span class="n">cloud_shadow</span><span class="p">)),</span> <span class="s2">&quot;qa_value&quot;</span>
    <span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="c1"># =&gt; 23.7</span>
<span class="n">percent_valid</span> <span class="o">=</span> <span class="n">qa_counts</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">qa_counts</span><span class="o">.</span><span class="n">integer</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">valid</span><span class="p">),</span> <span class="s2">&quot;percent_obs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="mi">100</span> <span class="o">-</span> <span class="n">percent_valid</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
23.67
</pre></div></div>
</div>
<p>The winner is: cirrus, cloud and cloud shadow, which somehow makes sense.</p>
<p>That means that we consider the following QA values as clear sky or valid pixels:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">valid</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([  0,   4,  16,  20,  32,  36,  48,  52,  64,  68,  80,  84,  96,
       100, 112, 116, 128, 132, 144, 148, 160, 164, 176, 180, 192, 196,
       208, 212, 224, 228, 240, 244])
</pre></div></div>
</div>
</div>
<div class="section" id="Convert-the-QA-layer-into-a-mask">
<h4>Convert the QA layer into a mask<a class="headerlink" href="#Convert-the-QA-layer-into-a-mask" title="Permalink to this headline">¶</a></h4>
<p>Given we know the QA values that we want to consider as valid or invalid pixels we can derive a mask array or GeoTIFF from a GeoTIFF QA layer.</p>
<p>Here we use the function <code class="docutils literal notranslate"><span class="pre">hls_qa_layer_to_mask</span></code> to quickly test if the masking with the valid values give us the same cloud cover as the mateadata.</p>
<p>Note that you have the following additional options:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">keep_255</span></code> (bool): If <code class="docutils literal notranslate"><span class="pre">True</span></code> this keeps the value 255 for the non sensed pixels.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mask_path</span></code> (str): If a path is given the function will create a raster of the mask there and not output an array.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">overwrite</span></code> (bool): Defines if a file existing at <code class="docutils literal notranslate"><span class="pre">mask_path</span></code> should be overwritten.</p></li>
</ul>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df_downloaded</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
    <span class="n">sceneid</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">path</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>
    <span class="n">qa_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;xxx_uncontrolled_hls/geotiffs/</span><span class="si">{sceneid}</span><span class="s1">/</span><span class="si">{sceneid}</span><span class="s1">__QA.tif&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="p">(</span><span class="n">qa_path</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">continue</span>

    <span class="n">clear_arr</span> <span class="o">=</span> <span class="n">nasa_hls</span><span class="o">.</span><span class="n">hls_qa_layer_to_mask</span><span class="p">(</span><span class="n">qa_path</span><span class="p">,</span>
                                              <span class="n">qa_valid</span><span class="o">=</span><span class="n">valid</span><span class="p">,</span>
                                              <span class="n">keep_255</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                              <span class="n">mask_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">n_pix</span> <span class="o">=</span> <span class="n">clear_arr</span><span class="o">.</span><span class="n">size</span>
    <span class="n">n_obs</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear_arr</span> <span class="o">!=</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">n_cloudy</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear_arr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">n_clear</span> <span class="o">=</span> <span class="p">(</span><span class="n">clear_arr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">cloud_cover</span> <span class="o">=</span> <span class="n">n_cloudy</span> <span class="o">/</span> <span class="p">(</span><span class="n">n_clear</span> <span class="o">+</span> <span class="n">n_cloudy</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="o">*</span> <span class="mi">90</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">qa_path</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of pixels             : </span><span class="si">{n_pix}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of obs.               : </span><span class="si">{n_obs}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of clear obs.         : </span><span class="si">{n_clear}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of cloudy obs.        : </span><span class="si">{n_cloudy}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloud cover - metadata       : </span><span class="si">{row.cloud_cover}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cloud cover - calculated     : {round(cloud_cover * 100, 1) }&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spatial coverage - metadata  : </span><span class="si">{row.spatial_coverage}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Spatial coverage - calculated: {round((n_obs / n_pix) * 100, 1) }&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
******************************************************************************************
xxx_uncontrolled_hls/geotiffs/HLS.L30.T32UNU.2018092.v1.4/HLS.L30.T32UNU.2018092.v1.4__QA.tif
Number of pixels             : 13395600
Number of obs.               : 3930335
Number of clear obs.         : 2999963
Number of cloudy obs.        : 930372
Cloud cover - metadata       : 24.0
Cloud cover - calculated     : 23.7
Spatial coverage - metadata  : 29.0
Spatial coverage - calculated: 29.3
******************************************************************************************
xxx_uncontrolled_hls/geotiffs/HLS.S30.T32UNU.2018092.v1.4/HLS.S30.T32UNU.2018092.v1.4__QA.tif
Number of pixels             : 13395600
Number of obs.               : 13272703
Number of clear obs.         : 1976262
Number of cloudy obs.        : 11296441
Cloud cover - metadata       : 85.0
Cloud cover - calculated     : 85.1
Spatial coverage - metadata  : 100.0
Spatial coverage - calculated: 99.1
******************************************************************************************
xxx_uncontrolled_hls/geotiffs/HLS.L30.T32UPU.2018092.v1.4/HLS.L30.T32UPU.2018092.v1.4__QA.tif
Number of pixels             : 13395600
Number of obs.               : 13395365
Number of clear obs.         : 11980540
Number of cloudy obs.        : 1414825
Cloud cover - metadata       : 11.0
Cloud cover - calculated     : 10.6
Spatial coverage - metadata  : 100.0
Spatial coverage - calculated: 100.0
******************************************************************************************
xxx_uncontrolled_hls/geotiffs/HLS.S30.T32UPU.2018092.v1.4/HLS.S30.T32UPU.2018092.v1.4__QA.tif
Number of pixels             : 13395600
Number of obs.               : 12915488
Number of clear obs.         : 4495212
Number of cloudy obs.        : 8420276
Cloud cover - metadata       : 66.0
Cloud cover - calculated     : 65.2
Spatial coverage - metadata  : 100.0
Spatial coverage - calculated: 96.4
</pre></div></div>
</div>
<p><strong>!!! NOTE AND WARNING !!!</strong></p>
<p><strong>There are some small irregularities between the metadata and the calculated values that should be investigated further.</strong></p>
<p><strong>Feel free to do so… (;</strong></p>
</div>
<div class="section" id="Visualize-the-mask">
<h4>Visualize the mask<a class="headerlink" href="#Visualize-the-mask" title="Permalink to this headline">¶</a></h4>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sceneid</span> <span class="o">=</span> <span class="s2">&quot;HLS.L30.T32UNU.2018092.v1.4&quot;</span>
<span class="n">src_nir</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xxx_uncontrolled_hls/geotiffs/</span><span class="si">{sceneid}</span><span class="s1">/</span><span class="si">{sceneid}</span><span class="s1">__NIR.tif&#39;</span><span class="p">)</span>
<span class="n">src_qa</span> <span class="o">=</span> <span class="n">rasterio</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;xxx_uncontrolled_hls/geotiffs/</span><span class="si">{sceneid}</span><span class="s1">/</span><span class="si">{sceneid}</span><span class="s1">__QA.tif&#39;</span><span class="p">)</span>
<span class="n">qa_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;xxx_uncontrolled_hls/geotiffs/</span><span class="si">{sceneid}</span><span class="s1">/</span><span class="si">{sceneid}</span><span class="s1">__QA.tif&#39;</span>

<span class="n">clear_arr</span> <span class="o">=</span> <span class="n">nasa_hls</span><span class="o">.</span><span class="n">hls_qa_layer_to_mask</span><span class="p">(</span><span class="n">qa_path</span><span class="p">,</span>
                                          <span class="n">qa_valid</span><span class="o">=</span><span class="n">valid</span><span class="p">,</span>
                                          <span class="n">keep_255</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                          <span class="n">mask_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                          <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">src_nir</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">6000</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;pink&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">sceneid</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="s2">&quot;NIR&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">src_qa</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;pink&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">sceneid</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="s2">&quot;QA&quot;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">clear_arr</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;pink&#39;</span><span class="p">)</span>
<span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">sceneid</span> <span class="o">+</span> <span class="s2">&quot; - &quot;</span> <span class="o">+</span> <span class="s2">&quot;clear&quot;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../_images/tutorials_Working_with_HLS_datasets_and_nasa_hls_46_0.png" src="../_images/tutorials_Working_with_HLS_datasets_and_nasa_hls_46_0.png" />
</div>
</div>
</div>
</div>
</div>
</div>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../index.html">nasa_hls</a></h1>








<h3>Navigation</h3>
<p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../readme_link.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer-area.html">Developer area</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../tutorials.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Query_and_download_hls_datasets_with_nasa_hls.html">Query and download HLS datasets with <em>nasa_hls</em></a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Working with HLS datasets: cloud cover, GeoTIFFs, and the QA band</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../changelog_link.html">Changelog</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
  <li><a href="../tutorials.html">Tutorials</a><ul>
      <li>Previous: <a href="Query_and_download_hls_datasets_with_nasa_hls.html" title="previous chapter">Query and download HLS datasets with <em>nasa_hls</em></a></li>
      <li>Next: <a href="../changelog_link.html" title="next chapter">Changelog</a></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019, Ben Mack.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.4.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="../_sources/tutorials/Working_with_HLS_datasets_and_nasa_hls.ipynb.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>